## Java内存区域溢出的解决思路

### 堆溢出

堆内存用完，无法创建新对象的时候就会抛出OutOfMemoryError

堆容量参数设置：-Xmx和-Xms

##### 解决思路

分析dump出来的堆转储快粘，先确定内存中导致OOM的对象是否有存在的必要，判断是内存泄漏还是内存溢出

内存泄漏

- 查看泄漏对象到GC roots的引用链，找到泄漏对象的引用链，分析垃圾收集器无法回收的原因

内存溢出

- 即对象有必要存在，先检查虚拟机的堆参数设置（-Xmx和-Xms），看看需不需要增大堆内存空间
- 从代码上检查是否存在生命周期过长的对象、存储结构不合理等情况

### 虚拟机栈和本地方法栈溢出

SOF异常：线程请求的栈深度大于虚拟机所允许的最大深度

OOM异常：如果虚拟机允许动态扩展，当无法申请到足够的内存时，便抛出异常

>  HotSpot虚拟机不支持扩展，只会在创建线程分配内存的时候会抛出OOM异常，其余情况只会有SOF异常

栈容量设置参数：-Xss

##### 解决思路

操作系统分配内存的思路

- 32Window系统的单个进程内存最大限制为2G，剩下2G
- 在减去最大堆容量、最大方法区容量后，程序计数器忽略不计，栈分到的内存相对较少

如果为每个线程分配的栈容量较大，能创建的线程数相对就少，因此当线程数超出的时候就会抛出SOF

- 解决办法是适当减小每个栈的容量

如果栈容量不大，线程创建过多也可能抛出SOF

- 解决办法是减少线程创建数量，若数量不能少，就只能减小堆内存和方法区内存

### 方法区（元空间）溢出

JDK8后，永久代完全被方法区替代，元空间溢出的情况较为少见

HstSpot提供了一些参数作为元空间的防御措施

- -XX:MaxMetspceSize：设置元空间最大值，没有限制
- -XX:MetaspaceSize：设置元空间初始大小，以字节为单位

